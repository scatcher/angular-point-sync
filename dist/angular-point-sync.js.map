{"version":3,"sources":["sync_point.ts","Lock.ts","sync_service.ts","presence_service.ts","index.ts"],"names":["ap","ap.sync","ap.sync.SyncPoint","ap.sync.SyncPoint.constructor","ap.sync.SyncPoint.processChanges","ap.sync.SyncPoint.registerChange","ap.sync.SyncPoint.subscribeToChanges","ap.sync.SyncPoint.unsubscribe","ap.sync.Lock","ap.sync.SyncService","ap.sync.SyncService.constructor","ap.sync.SyncService.createSyncPoint","ap.sync.SyncService.initialize","ap.sync.PresenceService","ap.sync.PresenceService.constructor","ap.sync.PresenceService.deleteSessionData","ap.sync.PresenceService.displayUserNotification","ap.sync.PresenceService.getSessionNotificationsArray","ap.sync.PresenceService.getSessionConnectioUrl","ap.sync.PresenceService.getUserConnectionUrl","ap.sync.PresenceService.getUsers","ap.sync.PresenceService.reloadBrowser","ap.sync.PresenceService.sendUserNotification","ap.sync.PresenceService.watchForNotifications","ap.sync.PresenceService.watchForReloadEvent","ap.sync.identifyBrowser","ap.sync.Run"],"mappings":"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","file":"angular-point-sync.js","sourcesContent":["/// <reference path=\"../typings/ap.d.ts\" />\r\n/// <reference path=\"../typings/tsd.d.ts\" />\r\n\r\nmodule ap.sync {\r\n    'use strict';\r\n\r\n    export interface ISyncServiceChangeEvent {\r\n        changeType: string; // 'add'|'update'|'delete';\r\n        listItemId: number;\r\n        userId: number;\r\n        time: number;\r\n    }\r\n\r\n    export interface ISyncServiceInitializationParams {\r\n        userId: number;\r\n        firebaseUrl: string;\r\n    }\r\n\r\n    export interface ISyncPoint {\r\n        eventLogLength: number;\r\n        recentEvents: ISyncServiceChangeEvent[];\r\n        registerChange(changeType: string, listItemId: number);\r\n        subscribeToChanges(callback: Function, unsubscribeOnStateChange: boolean): Function;\r\n        unsubscribe(callback);\r\n    }\r\n\r\n\r\n    export class SyncPoint implements ISyncPoint {\r\n        eventLogLength = 10;\r\n        changeNotifier;\r\n        recentEvents;\r\n        /** Container to hold all current subscriptions for the model */\r\n        subscriptions = [];\r\n\r\n        /**\r\n         *\r\n         * @param model\r\n         * @param updateQuery\r\n         */\r\n        constructor(private model: ap.Model) {\r\n            var syncPoint = this;\r\n\r\n            serviceIsInitialized\r\n                .then((initializationParams: ISyncServiceInitializationParams) => {\r\n\r\n                    syncPoint.changeNotifier = new Firebase(initializationParams.firebaseUrl + '/changes/' + model.list.title);\r\n\r\n                    var query = syncPoint.changeNotifier.limitToLast(syncPoint.eventLogLength);\r\n\r\n                    syncPoint.recentEvents = $firebaseArray(query);\r\n\r\n                    syncPoint.recentEvents.$loaded()\r\n                        .then((eventArray) => {\r\n\r\n                            /** Fired when anyone updates a list item */\r\n                            syncPoint.recentEvents.$watch((log) => {\r\n                                if (log.event === 'child_added') {\r\n                                    var newEvent: ISyncServiceChangeEvent = syncPoint.recentEvents.$getRecord(log.key);\r\n                                    /** Capture if event was caused by current user */\r\n                                    var externalTrigger = newEvent.userId !== initializationParams.userId;\r\n                                    syncPoint.processChanges(newEvent, externalTrigger);\r\n                                }\r\n                            });\r\n                        });\r\n\r\n\r\n                });\r\n\r\n\r\n        }\r\n\r\n        /**\r\n         *\r\n         * @param {ISyncServiceChangeEvent} newEvent Details of event.\r\n         * @param {boolean} externalTrigger Was the changed caused by another user.\r\n         */\r\n        private processChanges(newEvent: ISyncServiceChangeEvent, externalTrigger: boolean): void {\r\n            var syncPoint = this;\r\n            /** Notify subscribers */\r\n            _.each(syncPoint.subscriptions, (callback) => {\r\n                if (_.isFunction(callback)) {\r\n                    callback(newEvent, externalTrigger);\r\n                }\r\n            });\r\n        }\r\n\r\n        /**\r\n         * @ngdoc function\r\n         * @name SyncPoint.registerChange\r\n         * @methodOf SyncPoint\r\n         * @description\r\n         * Notify all other users listening to this model that a change has been made.\r\n         */\r\n        registerChange(changeType: string, listItemId: number) {\r\n            var syncPoint = this;\r\n            serviceIsInitialized\r\n                .then((initializationParams) => {\r\n                    if (syncPoint.recentEvents.length >= syncPoint.eventLogLength) {\r\n                        /** Trim the log to prevent unnecessary size */\r\n                        syncPoint.recentEvents.$remove(0);\r\n                    }\r\n\r\n                    syncPoint.recentEvents.$add({\r\n                        changeType: changeType,\r\n                        listItemId: listItemId,\r\n                        userId: initializationParams.userId,\r\n                        time: Firebase.ServerValue.TIMESTAMP\r\n                    });\r\n                });\r\n\r\n        }\r\n\r\n        /**\r\n         * @ngdoc function\r\n         * @name SyncPoint.subscribeToChanges\r\n         * @methodOf SyncPoint\r\n         * @description\r\n         * Allows subscribers (controllers & services) to be notified when change is made.\r\n         *\r\n         * @param {function} callback Callback to execute after a change is made.\r\n         * @param {boolean} [unsubscribeOnStateChange = true]\r\n         * @returns {function} Function used to unsubscribe.\r\n         */\r\n        subscribeToChanges(callback: Function, unsubscribeOnStateChange: boolean = true): Function {\r\n            var syncPoint = this;\r\n            if (syncPoint.subscriptions.indexOf(callback) === -1) {\r\n                /** Only register new subscriptions, ignore if subscription already exists */\r\n                syncPoint.subscriptions.push(callback);\r\n            }\r\n\r\n            var unsubscribe = () => this.unsubscribe(callback);\r\n\r\n            if (unsubscribeOnStateChange) {\r\n                //var $rootScope = $injector.get('$rootScope');\r\n\r\n                /** Unsubscribe from notifications when we leave this state */\r\n                $rootScope.$on('$stateChangeStart', () => {\r\n                    unsubscribe();\r\n                });\r\n\r\n            }\r\n\r\n            return unsubscribe;\r\n\r\n        }\r\n\r\n        unsubscribe(callback) {\r\n            var index = this.subscriptions.indexOf(callback);\r\n            if (index !== -1) {\r\n                this.subscriptions.splice(index, 1);\r\n            }\r\n        }\r\n    }\r\n}","/// <reference path=\"../typings/ap.d.ts\" />\r\n/// <reference path=\"../typings/tsd.d.ts\" />\r\n\r\nmodule ap.sync {\r\n    'use strict';\r\n\r\n    export interface ILockReference {\r\n        lockQueue: AngularFireArray;\r\n        myLockRef: ng.IPromise<Firebase>;\r\n        unlock(): void;\r\n    }\r\n\r\n    export interface IListItemLock {\r\n        userId: number;\r\n        time: string;\r\n    }\r\n\r\n    export function Lock(): ng.IPromise<ILockReference> {\r\n        var deferred = $q.defer();\r\n\r\n        var listItem = this;\r\n\r\n        /** Only can lock existing records */\r\n        if (listItem.id) {\r\n            var model = listItem.getModel();\r\n            /** Make sure user has rights to edit */\r\n            var userPermMask = listItem.resolvePermissions();\r\n            if (userPermMask.EditListItems) {\r\n\r\n                serviceIsInitialized\r\n                    .then((initializationParams) => {\r\n\r\n                        /** Reference to the firebase lock queue for this record*/\r\n                        var listItemLockRef = new Firebase(initializationParams.firebaseUrl + 'locks/' + model.list.title + '/' + listItem.id);\r\n                        var lockQueue = $firebaseArray(listItemLockRef);\r\n\r\n                        /** Reference to the lock record I created */\r\n                        var myLockRef = lockQueue.$add({\r\n                            userId: initializationParams.userId,\r\n                            time: Firebase.ServerValue.TIMESTAMP\r\n                        });\r\n\r\n                        /** Passed as a reference so we can remove the lock when the modal form is closed*/\r\n                        var unlock = () => myLockRef.then((myLock) => myLock.remove());\r\n                        \r\n                        //Automatically remove any list item locks older than 4 hours\r\n                        lockQueue.$loaded(() => _.each(lockQueue, (listItemLock: IListItemLock) => {\r\n                            if (moment().diff(lockQueue, 'hours') > 4) {\r\n                                console.log('Purging expired list item lock.', listItemLock);                                \r\n                                lockQueue.$remove(listItemLock);\r\n                            }\r\n                        }));\r\n\r\n                        var lockReference = { lockQueue, myLockRef, unlock };\r\n\r\n                        myLockRef.then((lockRef) => {\r\n                            /** Remove the lock in the event the user looses connection, changes page, or closes browser*/\r\n                            lockRef.onDisconnect().remove();\r\n                            // var key = lockRef.key();\r\n                            // var index = lockQueue.$indexFor(key); // returns location in the array                            \r\n                            // deferredLock.resolve(lockQueue[index]);\r\n\r\n                        });\r\n                        \r\n                        // Include a referece to the lock in the queue                            \r\n\r\n                        deferred.resolve(lockReference);\r\n\r\n                    });\r\n\r\n            } else {\r\n                /** User doesn't have edit rights */\r\n                deferred.resolve({});\r\n            }\r\n        } else {\r\n            /** New record so can't lock */\r\n            deferred.resolve({});\r\n        }\r\n        return deferred.promise;\r\n\r\n    }\r\n}","/// <reference path=\"../typings/ap.d.ts\" />\r\n/// <reference path=\"../typings/tsd.d.ts\" />\r\n\r\nmodule ap.sync {\r\n    'use strict';\r\n\r\n    export var $q,\r\n        $firebaseArray,\r\n        $rootScope,\r\n        apListItemFactory,\r\n        deferred: ng.IDeferred<ISyncServiceInitializationParams>,\r\n        serviceIsInitialized: ng.IPromise<ISyncServiceInitializationParams>;\r\n\r\n    export interface ISyncService {\r\n        createSyncPoint(model: ap.IModel): ISyncPoint;\r\n        initialize(userId: number, firebaseUrl: string): void;\r\n        Lock: () => ng.IPromise<ILockReference>;\r\n    }\r\n\r\n    export class SyncService implements ISyncService {\r\n        /** Minification safe - we're using leading and trailing underscores but gulp plugin doesn't treat them correctly */\r\n        static $inject = ['$firebaseArray', '$q', 'apListItemFactory', '$rootScope'];\r\n\r\n        constructor(_$firebaseArray_, _$q_, _apListItemFactory_, _$rootScope_) {\r\n            /** Expose to service scope */\r\n            $q = _$q_;\r\n            $firebaseArray = _$firebaseArray_;\r\n            apListItemFactory = _apListItemFactory_;\r\n            $rootScope = _$rootScope_;\r\n\r\n            /** Create a deferred object that will allow service to proceed once a userId is provided */\r\n            deferred = $q.defer();\r\n            serviceIsInitialized = deferred.promise;\r\n        }\r\n\r\n        createSyncPoint(model: ap.Model): ISyncPoint {\r\n            return new SyncPoint(model);\r\n        }\r\n\r\n        /**\r\n         * @description Service waits for userId to be provided before adding the watch to event array.\r\n         * @param {{userId: userId, firebaseUrl: firebaseUrl}} userId\r\n         */\r\n        /**\r\n         * @description Service waits for userId to be provided before adding the watch to event array.\r\n         * @param {number} userId\r\n         * @param {string} firebaseUrl\r\n         */\r\n        initialize(userId: number, firebaseUrl: string): void {\r\n            deferred.resolve({ userId: userId, firebaseUrl: firebaseUrl });\r\n            apListItemFactory.ListItem.prototype.lock = Lock;\r\n        }\r\n\r\n        Lock = Lock;\r\n    }\r\n}","/// <reference path=\"../typings/ap.d.ts\" />\r\n/// <reference path=\"../typings/tsd.d.ts\" />\r\n\r\nmodule ap.sync {\r\n    'use strict';\r\n\r\n    var service: PresenceService;\r\n\r\n    export interface IFirebaseSessionObject extends AngularFireObject {\r\n        browser: string;\r\n        connected: number;\r\n        lastActive: number;\r\n        notifications?: IUserNotification[];\r\n        path: string;\r\n        reload: boolean; //Hard refresh browser\r\n    }\r\n\r\n    export interface IUserNotification {\r\n        message: string;\r\n        title?: string;\r\n        toastType: string;\r\n        toastrOptions?: Object;\r\n        senderId?:number;\r\n        senderSessionKey?:string;\r\n    }\r\n\r\n    export interface IFirebaseUsersObject {\r\n        [key: number]: { //User ID\r\n            connections: { [key: string]: IFirebaseSessionObject } //Object for each active connection\r\n            lastOnline: number; //Timestamp\r\n        }\r\n    }\r\n\r\n    export interface IFirebaseWatchEvent {\r\n        event: string;\r\n        key: string;\r\n        prevId?: string;\r\n    }\r\n\r\n    /**\r\n     * @ngdoc Object\r\n     * @name PresenceService\r\n     * @description\r\n     * Creates a realtime reference to where each user is within the application when logged in, what browser they're using, when\r\n     * the session was started, and if not online when the last time they were online.\r\n     */\r\n    export class PresenceService {\r\n        identifyBrowser = identifyBrowser;\r\n        initializeSession: ng.IPromise<IFirebaseSessionObject>;\r\n        userConnectionUrl: string;\r\n        users: AngularFireObject;\r\n        sessionConnection: Firebase;\r\n        static $inject = ['$q', '$rootScope', '$firebaseArray', '$firebaseObject', '$location', 'apSyncService'];\r\n        constructor(private $q: ng.IQService, $rootScope: angular.IRootScopeService, private $firebaseArray: AngularFireArrayService, private $firebaseObject: AngularFireObjectService,\r\n            $location: angular.ILocationService, apSyncService: SyncService) {\r\n\r\n            service = this;\r\n            var deferred = $q.defer();\r\n            service.initializeSession = deferred.promise;\r\n\r\n            //Wait for SyncService to be initialized with current users userId and firebaseUrl\r\n            serviceIsInitialized.then((initializationParamsObject: ISyncServiceInitializationParams) => {\r\n                var userId = initializationParamsObject.userId;\r\n                var firebaseUrl = initializationParamsObject.firebaseUrl;\r\n                var firebaseRoot = firebaseUrl.replace('offline/', '');\r\n                service.userConnectionUrl = firebaseUrl + 'users/' + userId + '/';\r\n\r\n                // var usersRef = new Firebase(firebaseUrl + 'users');\r\n                // service.users = $firebaseObject(usersRef).$loaded;\r\n\r\n                // since I can connect from multiple devices or browser tabs, we store each connection instance separately\r\n                // any time that connectionsRef's value is null (i.e. has no children) I am offline\r\n                var thisConnectionRef = new Firebase(service.userConnectionUrl + 'connections');\r\n\r\n                // stores the timestamp of my last disconnect (the last time I was seen online)\r\n                var lastOnlineRef = new Firebase(service.userConnectionUrl + 'lastOnline');\r\n                var connectedRef = new Firebase(firebaseRoot + '.info/connected');\r\n\r\n\r\n                connectedRef.on('value', function(snap) {\r\n                    if (snap.val() === true) {\r\n                        // We're connected (or reconnected)! Do anything here that should happen only if online (or on reconnect)\r\n\r\n                        // add this device to my connections list\r\n                        // this value contains info about the device and connection start timestamp\r\n                        service.sessionConnection = thisConnectionRef.push({\r\n                            browser: identifyBrowser(),\r\n                            connected: Firebase.ServerValue.TIMESTAMP,\r\n                            lastActive: Firebase.ServerValue.TIMESTAMP,\r\n                            path: $location.url(),\r\n                            reload: false\r\n                        });\r\n\r\n                        //Update the current path whenever state changes\r\n                        $rootScope.$on('$stateChangeSuccess', function(event, current, previous, rejection) {\r\n                            service.sessionConnection.update({\r\n                                lastActive: Firebase.ServerValue.TIMESTAMP,\r\n                                path: $location.url()\r\n                            });\r\n                        });\r\n\r\n                        // when I disconnect, remove this device\r\n                        service.sessionConnection.onDisconnect().remove();\r\n\r\n                        // when I disconnect, update the last time I was seen online\r\n                        lastOnlineRef.onDisconnect().set(Firebase.ServerValue.TIMESTAMP);\r\n\r\n                        var activeSessionObject = service.$firebaseObject(service.sessionConnection);\r\n                        deferred.resolve(activeSessionObject);\r\n\r\n                        // watch for events\r\n                        service.watchForReloadEvent(activeSessionObject);\r\n                        service.watchForNotifications(userId, activeSessionObject.$id);\r\n                    }\r\n                });\r\n            })\r\n\r\n        }\r\n        deleteSessionData(userId: number, sessionKey: string) {\r\n            return service.getSessionConnectioUrl(userId, sessionKey).then((sessionConnectionUrl) => {\r\n                var sessionRef = new Firebase(sessionConnectionUrl);\r\n                return sessionRef.remove();\r\n            });\r\n        }\r\n\r\n        displayUserNotification(notification: IUserNotification): void {\r\n            if(window.toastr) {\r\n                window.toastr[notification.toastType](notification.message, notification.title, notification.toastrOptions);\r\n            } else {\r\n                console[notification.toastType](notification.title, notification.message);\r\n            }\r\n        }\r\n\r\n        getSessionNotificationsArray(userId: number, sessionKey: string): ng.IPromise<AngularFireArray> {\r\n            return service.getSessionConnectioUrl(userId, sessionKey).then((sessionConnectionUrl) => {\r\n                var notificationsRef = new Firebase(sessionConnectionUrl + '/notifications');\r\n                return service.$firebaseArray(notificationsRef).$loaded();\r\n            })\r\n        }\r\n        getSessionConnectioUrl(userId: number, sessionKey: string): ng.IPromise<string> {\r\n            return serviceIsInitialized.then((initializationParamsObject: ISyncServiceInitializationParams) => {\r\n                return initializationParamsObject.firebaseUrl + 'users/' + userId + '/connections/' + sessionKey;\r\n            });\r\n        }\r\n        getUserConnectionUrl(userId: number): ng.IPromise<string> {\r\n            return serviceIsInitialized.then((initializationParamsObject: ISyncServiceInitializationParams) => {\r\n                return initializationParamsObject.firebaseUrl + 'users/' + userId;\r\n            });\r\n        }\r\n\r\n        getUsers(): ng.IPromise<IFirebaseUsersObject> {\r\n            return serviceIsInitialized.then((initializationParamsObject: ISyncServiceInitializationParams) => {\r\n                if (!service.users) {\r\n                    var usersRef = new Firebase(initializationParamsObject.firebaseUrl + 'users');\r\n                    service.users = service.$firebaseObject(usersRef);\r\n                }\r\n                return service.users;\r\n            });\r\n        }\r\n        reloadBrowser(userId: number, sessionKey: string): void {\r\n            service.getSessionConnectioUrl(userId, sessionKey).then((sessionConnectionUrl) => {\r\n                var sessionRef = new Firebase(sessionConnectionUrl);\r\n                var sessionObject = service.$firebaseObject(sessionRef);\r\n                sessionObject.$loaded()\r\n                    .then(() => {\r\n                        sessionObject.reload = true;\r\n                        sessionObject.$save();\r\n                    })\r\n            });\r\n        }\r\n        sendUserNotification(userId: number, sessionKey: string, notification: IUserNotification): ng.IPromise<IUserNotification> {\r\n            var deferred = this.$q.defer();\r\n            this.getSessionNotificationsArray(userId, sessionKey)\r\n                .then((sessionNotifications) => {\r\n                    deferred.resolve(sessionNotifications.$add(notification));\r\n                });\r\n\r\n            return deferred.promise;\r\n        }\r\n        watchForNotifications(userId: number, sessionKey: string): void {\r\n            this.getSessionNotificationsArray(userId, sessionKey)\r\n                .then((notificationArray: AngularFireArray) => notificationArray.$watch((eventObject) => {\r\n                    //Trigger when a new notification is added to the session notifications array\r\n                    if (eventObject.event === 'child_added') {\r\n                        _.each(notificationArray, (notification: IUserNotification, index) => {\r\n                            service.displayUserNotification(notification);\r\n                            notificationArray.$remove(notification);\r\n                        });\r\n                    }\r\n                }));\r\n\r\n        }\r\n        watchForReloadEvent(activeSessionObject: IFirebaseSessionObject): void {\r\n            activeSessionObject.$watch((eventObject: IFirebaseWatchEvent) => {\r\n                if (!!activeSessionObject.reload) {\r\n                    activeSessionObject.reload = false;\r\n                    activeSessionObject.$save();\r\n                    location.reload(true);\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    function identifyBrowser(): string {\r\n        var ua = navigator.userAgent, tem,\r\n            M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\\/))\\/?\\s*(\\d+)/i) || [];\r\n        if (/trident/i.test(M[1])) {\r\n            tem = /\\brv[ :]+(\\d+)/g.exec(ua) || [];\r\n            return 'IE ' + (tem[1] || '');\r\n        }\r\n        if (M[1] === 'Chrome') {\r\n            tem = ua.match(/\\b(OPR|Edge)\\/(\\d+)/);\r\n            if (tem != null) return tem.slice(1).join(' ').replace('OPR', 'Opera');\r\n        }\r\n        M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];\r\n        if ((tem = ua.match(/version\\/(\\d+)/i)) != null) M.splice(1, 1, tem[1]);\r\n        return M.join(' ');\r\n    }\r\n\r\n}","/// <reference path=\"../typings/tsd.d.ts\" />\r\n/// <reference path=\"sync_point.ts\" />\r\n/// <reference path=\"lock.ts\" />\r\n/// <reference path=\"sync_service.ts\" />\r\n/// <reference path=\"presence_service.ts\" />\r\n\r\n/**\r\n * @ngdoc service\r\n * @name ap.sync\r\n * @description\r\n * Supports 3-way data binding if you decide to incorporate firebase (any change by any user\r\n * to a list item is mirrored across users). The data isn't saved to firebase but the change\r\n * event is so all subscribers are notified to request an update from SharePoint.\r\n *\r\n * In order to get this service to work, you need to have angularFire installed and have your\r\n * firebase url set at apConfig.firebaseURL.\r\n *\r\n * This will create a change point at: apConfig.firebaseURL + '/changes/' + model.list.title\r\n * The point contains Firebase.ServerValue.TIMESTAMP to determine the time of the most recent change.\r\n *\r\n * @example\r\n * <h3>Example of how to set the firebase url</h3>\r\n * <pre>\r\n * .run(function (apConfig) {\r\n *   //Set the folder where offline XML is stored\r\n *   apConfig.firebaseURL = 'My Firebase URL';\r\n *\r\n * });\r\n * </pre>\r\n *\r\n * <h3>Example of how to register from the model</h3>\r\n * <pre>\r\n * //Add a subscription service that will automatically keep data in sync with all other active users\r\n * model.sync = apSyncService.createSyncPoint(model);\r\n *\r\n * model.sync.subscribeToChanges(function () {\r\n *    //Do something because a change has occurred\r\n *\r\n *  }, true); //Unsubscribe on route change so we don't keep reference in future\r\n * </pre>\r\n *\r\n */\r\n\r\nmodule ap.sync {\r\n    'use strict';\r\n\r\n    angular.module('apSync', ['angularPoint'])\r\n        .service('apSyncService', SyncService)\r\n        .service('apPresenceService', PresenceService)\r\n        .run(Run)\r\n\r\n    //Instantiate immediately\r\n    function Run(apPresenceService) {}\r\n\r\n}"],"sourceRoot":"/source/"}